<!-- 0234e249-625b-47d1-afe9-b84892517d2c 23de5f4d-55b9-4942-81f8-f6aaa25ed044 -->
# إضافة ميزة المرفقات للشات

## نظرة عامة

إضافة ميزة رفع المرفقات (صور، فيديو، صوت، ملفات) في الشات مع:

- رفع سريع باستخدام Laravel Storage
- تخزين في الخلفية عبر Redis Queues
- عرض المرفقات بنمط WhatsApp
- دعم أنواع متعددة: صور، فيديو، صوت، ملفات

## المكتبات المطلوبة

- `intervention/image` - معالجة الصور (اختياري)
- Laravel Queues مع Redis - للتخزين في الخلفية
- Laravel Storage - للرفع السريع

## التغييرات المطلوبة

### 1. قاعدة البيانات

- إنشاء migration لجدول `message_attachments`:
- `id`, `message_id`, `file_path`, `file_name`, `file_type` (image/video/audio/file), `file_size`, `mime_type`, `thumbnail_path` (للصور والفيديو), `duration` (للصوت والفيديو), `timestamps`
- إضافة indexes على `message_id`, `file_type`
- إضافة foreign key على `message_id`

### 2. النماذج (Models)

- تحديث `Message` model:
- إضافة علاقة `hasMany` مع `MessageAttachment`
- إضافة accessor للتحقق من وجود مرفقات
- إنشاء `MessageAttachment` model:
- `fillable`: `message_id`, `file_path`, `file_name`, `file_type`, `file_size`, `mime_type`, `thumbnail_path`, `duration`
- `casts`: `file_size` => `integer`, `duration` => `integer`
- علاقة `belongsTo` مع `Message`

### 3. Jobs للتخزين في الخلفية

- إنشاء `ProcessMessageAttachment` job:
- استقبال الملف المؤقت من Redis
- حفظ الملف في Storage
- إنشاء thumbnail للصور والفيديو
- حفظ بيانات المرفق في قاعدة البيانات
- تحديث الرسالة بالمرفق

### 4. Controller

- تحديث `HomeController::sendMessage`:
- قبول الملفات في الطلب
- حفظ الملفات مؤقتاً في Redis
- إنشاء Job للتخزين في الخلفية
- إرجاع رسالة فورية مع معلومات المرفق المؤقت
- إضافة method `getAttachment`:
- إرجاع الملف من Storage
- التحقق من الصلاحيات

### 5. Events

- تحديث `MessageSent` event:
- إضافة معلومات المرفقات في البيانات المرسلة

### 6. Frontend (Vue/Inertia)

- تحديث مكون إرسال الرسائل:
- إضافة زر لإرفاق الملفات
- عرض معاينة للمرفقات قبل الإرسال
- رفع الملفات مع الرسالة
- عرض حالة الرفع (uploading/success/failed)
- تحديث مكون عرض الرسائل:
- عرض المرفقات حسب النوع:
- الصور: معاينة مصغرة مع إمكانية التكبير
- الفيديو: مشغل فيديو
- الصوت: مشغل صوت
- الملفات: رابط تحميل مع أيقونة
- عرض thumbnail للصور والفيديو
- عرض معلومات الملف (الحجم، المدة للصوت/الفيديو)

### 7. التكوين

- تحديث `config/filesystems.php`:
- إضافة disk مخصص للمرفقات
- تحديث `config/queue.php`:
- التأكد من استخدام Redis للـ queues

### 8. Validation

- إنشاء Form Request `SendMessageRequest`:
- التحقق من الملفات:
- `attachments.*` => `file|max:10240` (10MB)
- `attachments.*` => `mimes:jpeg,jpg,png,gif,webp,mp4,avi,mov,mp3,wav,ogg,pdf,doc,docx,xls,xlsx`
- التحقق من الرسالة (مطلوبة إذا لم تكن هناك مرفقات)

## الملفات المطلوبة

### Backend

- `database/migrations/XXXX_XX_XX_create_message_attachments_table.php`
- `app/Models/MessageAttachment.php`
- `app/Jobs/ProcessMessageAttachment.php`
- `app/Http/Requests/SendMessageRequest.php`
- تحديث `app/Models/Message.php`
- تحديث `app/Http/Controllers/HomeController.php`
- تحديث `app/Events/MessageSent.php`

### Frontend

- تحديث مكون إرسال الرسائل
- تحديث مكون عرض الرسائل
- إضافة مكونات عرض المرفقات حسب النوع

## خطوات التنفيذ

1. إنشاء migration لجدول `message_attachments`
2. إنشاء `MessageAttachment` model
3. تحديث `Message` model
4. إنشاء `ProcessMessageAttachment` job
5. تحديث `HomeController::sendMessage`
6. إنشاء `SendMessageRequest` للتحقق
7. تحديث `MessageSent` event
8. تحديث Frontend لإضافة المرفقات
9. تحديث Frontend لعرض المرفقات
10. اختبار النظام

## ملاحظات

- الملفات تُحفظ مؤقتاً في Redis قبل التخزين النهائي
- التخزين النهائي يتم في الخلفية عبر Queue
- الصور والفيديو تُعالج لإنشاء thumbnails
- المرفقات تُعرض بنمط WhatsApp (صور مصغرة، مشغلات للصوت/الفيديو)

### To-dos

- [ ] إنشاء migration لجدول message_attachments مع جميع الحقول المطلوبة
- [ ] إنشاء MessageAttachment model مع العلاقات والـ casts
- [ ] تحديث Message model لإضافة علاقة hasMany مع MessageAttachment
- [ ] إنشاء ProcessMessageAttachment job للتخزين في الخلفية
- [ ] إنشاء SendMessageRequest للتحقق من الملفات والرسالة
- [ ] تحديث HomeController::sendMessage لدعم المرفقات والـ Redis
- [ ] تحديث MessageSent event لإضافة معلومات المرفقات
- [ ] تحديث Frontend لإضافة زر المرفقات ومعاينة الملفات
- [ ] تحديث Frontend لعرض المرفقات بنمط WhatsApp (صور، فيديو، صوت، ملفات)
- [ ] إضافة method getAttachment في HomeController لإرجاع الملفات